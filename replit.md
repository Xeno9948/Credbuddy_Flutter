# CredBuddy — AI Credit & Cashflow Assistant

## CredBuddy Positioning: Data Tool (Decision-support only)

CredBuddy is a **data-driven credit risk insight tool**. It provides descriptive risk indicators, scores, confidence levels, and data coverage based on observed cashflow data.

**What CredBuddy does:**
- Provides descriptive, informational credit risk insights
- Generates scores, risk bands, confidence levels, and data coverage metrics
- Uses neutral, FAIS-safe language throughout

**What CredBuddy does NOT do:**
- Does NOT provide financial advice or recommendations
- Does NOT approve or decline applications
- Does NOT make credit decisions of any kind
- Does NOT act as a financial advisor or intermediary

**Standard disclaimers:**
- Short (UI/WhatsApp): "Decision-support only. Final decisions remain with you."
- Full (PDF/Terms): "CredBuddy provides data-driven credit risk insights for informational purposes only. CredBuddy does not provide financial advice, credit decisions, or recommendations. The final decision remains entirely with the user or authorized partner."

## Overview

This is a production-ready MVP for **CredBuddy**, an AI Credit & Cashflow Assistant targeting micro-entrepreneurs in South Africa. The system has two main components:

1. **WhatsApp Assistant** — A chatbot that onboards entrepreneurs, collects daily revenue/expenses, provides cashflow snapshots, runs hypothetical scenario estimates, and computes a credit risk score (0–1000).
2. **Partner Portal** — A web-based dashboard for risk partners/credit analysts to search applicants, view scores/bands/confidence/flags, review score history, and access credit risk data.

Both components share a single PostgreSQL database and a common scoring engine. The project also includes an **Explainable AI** layer that translates scoring features into human-readable explanations for two audiences: entrepreneurs (WhatsApp-friendly, descriptive, in English) and analysts (neutral, structured, in English).

Additional pages:
3. **User Manual** (`/manual`) — In-app guide covering getting started, subscription tiers, chat commands, credit score explanation, and partner portal usage.
4. **Risk Manager Dashboard** (`/partner`) — Comprehensive dashboard for partners with overview cards, risk band distribution chart, risk pie chart, flagged applicant alerts, recent activity feed, and applicant search.

**Important**: This is decision-support only. The system is NOT a financial advisor, does NOT make credit decisions, and includes FAIS-safe disclaimers throughout.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Monorepo Structure

The project is a single monorepo (not split into workspace packages) with these key directories:

- **`client/`** — React frontend (Vite-based SPA)
- **`server/`** — Express.js backend (TypeScript)
- **`shared/`** — Shared code between client and server (schema, explainability module)
- **`attached_assets/`** — Product requirement documents and specs
- **`migrations/`** — Database migrations generated by Drizzle Kit

### Frontend Architecture

- **Framework**: React 18 with TypeScript
- **Build Tool**: Vite with HMR support
- **Routing**: Wouter (lightweight client-side router)
- **State Management**: TanStack React Query for server state, Zustand for local mock state
- **UI Components**: shadcn/ui (New York style) with Radix UI primitives
- **Styling**: Tailwind CSS v4 with CSS variables for theming
- **Charts**: Recharts for data visualization
- **Animations**: Framer Motion
- **Fonts**: Inter (body) and Space Grotesk (display)

**Key Pages**:
- `/` — Main dashboard with WhatsApp phone simulator (left) and admin analytics dashboard (right)
- `/partner/login` — Partner portal login
- `/partner` — Partner dashboard
- `/partner/applicant/:id` — Individual applicant detail view

The main dashboard features a phone simulator component that mimics a WhatsApp interface, allowing users to interact with the chatbot. The admin dashboard on the right updates in real-time showing scoring data, charts, and feature breakdowns.

### Backend Architecture

- **Runtime**: Node.js with TypeScript (tsx for development)
- **Framework**: Express.js v5
- **API Pattern**: RESTful JSON API under `/api/*` prefix
- **Build**: esbuild for production server bundle, Vite for client assets

**Key Server Modules**:
- `server/routes.ts` — API route definitions including partner auth middleware (API key based with SHA-256 hashing)
- `server/scoring.ts` — Credit scoring engine computing scores from daily entries and cash estimates. Produces a 0–1000 score with A/B/C/D bands, confidence percentages, flags, and a 6-feature breakdown (data discipline, revenue stability, expense pressure, buffer behavior, trend momentum, shock recovery)
- `server/storage.ts` — Database access layer using Drizzle ORM with a comprehensive interface for all entities
- `server/vite.ts` — Vite dev server integration for development mode
- `server/static.ts` — Static file serving for production builds

**Development vs Production**:
- Development: Vite dev server runs as middleware within Express, providing HMR
- Production: Client is pre-built to `dist/public/`, served as static files; server bundled to `dist/index.cjs`

### Database

- **Database**: PostgreSQL (required, configured via `DATABASE_URL` environment variable)
- **ORM**: Drizzle ORM with `drizzle-zod` for schema validation
- **Schema Location**: `shared/schema.ts`
- **Migration Tool**: Drizzle Kit (`npm run db:push` for schema push)

**Core Tables**:
- `users` — Phone-based user records
- `business_profiles` — Business name, type (Retail/Service/Food/Transport), notification preferences, timezone, language
- `conversation_states` — WhatsApp conversation flow state machine (JSON state data)
- `daily_entries` — Daily revenue and expense records (amounts in cents)
- `cash_estimates` — Cash buffer snapshots
- `score_snapshots` — Historical credit score records
- `partners` — Risk partner accounts with API keys
- `partner_user_access` — Partner-to-user access control
- `decision_requests` — Decision packet request audit trail
- `audit_logs` — System audit logging
- `message_logs` — WhatsApp message logging (inbound/outbound)
- `jobs` — DB-backed job queue (fallback for when Redis/BullMQ unavailable)

### Explainable AI Module

Located in `shared/explainability/`, this is a pure interpretation layer that:
1. Classifies each of the 6 scoring features into positive/neutral/negative buckets based on thresholds (≥0.7 positive, ≥0.4 neutral, <0.4 negative)
2. Maps classifications to deterministic human-readable text labels (Dutch for entrepreneurs, English for analysts)
3. Generates structured breakdown with summary, drivers, improvement tips, and disclaimers
4. Optionally polishes text via OpenAI GPT-4o-mini (wording only, no recalculation)
5. Renders audience-specific output: WhatsApp-friendly format for entrepreneurs, structured JSON for analysts

**Design Decision**: Deterministic mapping first, LLM only for optional wording polish. This ensures consistency and legal safety — the module never recalculates scores or makes decisions.

### LLM Guardrails Module (FAIS-safe)

Located in `shared/llm/`, this module ensures all LLM outputs comply with FAIS (Financial Advisory and Intermediary Services Act) requirements:
- `systemPrompts.ts` — FAIS-safe base system prompts for polishing, scenarios, and general use
- `prohibitedTerms.ts` — List of forbidden words/phrases (approve, decline, recommend, advice, should, must, eligible, creditworthy, etc.) with neutral replacements
- `sanitizeOutput.ts` — Post-processing filter that scans LLM output for prohibited terms, auto-rewrites with neutral alternatives, or falls back to deterministic template text
- `buildPrompt.ts` — Helper to build prompts with consistent FAIS-safe structure

All LLM calls go through this pipeline: FAIS-safe system prompt → LLM generation → prohibited terms scan → auto-rewrite or safe fallback.

### Authentication & Authorization

- **Partner API Access**: API key-based authentication via `X-API-KEY` header, keys hashed with SHA-256 before storage
- **Admin Access**: Password-based (via `ADMIN_PASSWORD` env var)
- **Session**: Client-side session context with auto-seeding of demo data

### Scoring Engine

The credit scoring engine (`server/scoring.ts`) analyzes the last 14 days of daily entries and produces:
- **Score**: 0–1000 integer
- **Band**: A (lower risk), B (moderate), C (elevated), D (higher risk)
- **Confidence**: 0–100% based on data availability
- **Flags**: Risk indicators (e.g., "R1 Low reliability")
- **Feature Breakdown**: Six normalized (0–1) features — dd (data discipline), rs (revenue stability), ep (expense pressure), bb (buffer behavior), tm (trend momentum), sr (shock recovery)

## External Dependencies

### Required Services
- **PostgreSQL** — Primary database (`DATABASE_URL` env var required)

### Optional Services
- **OpenAI API** — Used for LLM text polishing in explainability module and natural language chat responses (`OPENAI_API_KEY`)
- **Meta WhatsApp Cloud API** — WhatsApp messaging integration (`WHATSAPP_TOKEN`, `WHATSAPP_PHONE_NUMBER_ID`, `WHATSAPP_VERIFY_TOKEN`)
- **Redis** — Optional for BullMQ job queue (`REDIS_URL`); falls back to DB-backed queue

### Environment Variables
```
DATABASE_URL=              # Required: PostgreSQL connection string
OPENAI_API_KEY=            # Optional: OpenAI API for LLM features
WHATSAPP_TOKEN=            # Optional: Meta WhatsApp Cloud API token
WHATSAPP_PHONE_NUMBER_ID=  # Optional: WhatsApp business phone number ID
WHATSAPP_VERIFY_TOKEN=     # Optional: Webhook verification token
ADMIN_PASSWORD=            # Admin portal access
TZ_DEFAULT=Africa/Johannesburg
REDIS_URL=                 # Optional: Redis for BullMQ
```

### Key NPM Packages
- `drizzle-orm` + `drizzle-kit` — Database ORM and migrations
- `express` v5 — HTTP server
- `@tanstack/react-query` — Client-side data fetching
- `recharts` — Dashboard charts
- `framer-motion` — UI animations
- `zod` + `drizzle-zod` — Runtime validation
- `wouter` — Client routing
- `zustand` — Client state management
- `date-fns` — Date utilities
- `connect-pg-simple` — PostgreSQL session store